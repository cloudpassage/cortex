version: '2'

services:
  rabbitmq:
    container_name: rabbitmq
    hostname: rabbitmq
    image: docker.io/rabbitmq:3-management
    restart: always
    depends_on:
      - redis
    networks:
      - octo_box
  flower:
    container_name: flower
    image: docker.io/halotools/halocelery:v0.4.7
    command: celery flower -A halocelery --address=0.0.0.0 --port=5555 -l INFO
    environment:
      CELERY_BACKEND_URL: redis://redis
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672//
####################################
#    Flower doesn't use SSL, so only enable this in a controlled
#    troubleshooting environment.  OCTO-BOT can list tasks for you with
#    "donbot tasks"
#
#    ports:
#      - "5555:5555"
####################################
    restart: always
    read_only: true
    depends_on:
      - rabbitmq
    links:
      - "rabbitmq:5672"
      - "redis:6379"
    networks:
      - octo_box
  celeryworker:
    container_name: celeryworker
    image: docker.io/halotools/halocelery:v0.4.7
    command: celery worker -A halocelery -l INFO
    user: root
    restart: always
    environment:
      CELERY_BACKEND_URL: redis://redis
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672//
#####################################
# API keys, account information
#####################################
      HALO_API_KEY: ${HALO_API_KEY}
      HALO_API_SECRET_KEY: ${HALO_API_SECRET_KEY}
      HALO_API_KEY_RW: ${HALO_API_KEY_RW}
      HALO_API_SECRET_KEY_RW: ${HALO_API_SECRET_KEY_RW}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_ROLE_NAME: ${AWS_ROLE_NAME}
      AWS_ACCOUNT_NUMBERS: ${AWS_ACCOUNT_NUMBERS}
#####################################
# Container image versions
#####################################
      EC2_HALO_DELTA_VERSION: v0.1
      FIREWALL_GRAPH_VERSION: 0.1.1
      SCANS_TO_S3_VERSION: v0.14
      EVENTS_TO_S3_VERSION: v0.10
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - rabbitmq
    links:
      - "rabbitmq:5672"
      - "redis:6379"
    networks:
      - octo_box
  redis:
    container_name: redis
    image: docker.io/redis:3-alpine
    restart: always
    networks:
      - octo_box
  scheduler:
    container_name: scheduler
    image: docker.io/halotools/halocelery:v0.4.7
    command: celery beat -A halocelery -l INFO
    restart: always
    depends_on:
      - celeryworker
    links:
      - "rabbitmq:5672"
      - "redis:6379"
      - "flower:5555"
    environment:
      EVENT_EXPORT_HOUR: 19
      EVENT_EXPORT_MIN: 21
      SCAN_EXPORT_HOUR: 19
      SCAN_EXPORT_MIN: 21
      CELERY_BACKEND_URL: redis://redis
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672//
      FLOWER_HOST: http://flower:5555
      SLACK_API_TOKEN: ${SLACK_API_TOKEN}
      SLACK_CHANNEL: ${SLACK_CHANNEL}
      MONITOR_EVENTS: "yes"
      ARCHIVE_SCANS: "yes"
      SCANS_S3_BUCKET: ${SCANS_S3_BUCKET}
      ARCHIVE_EVENTS: "yes"
      EVENTS_S3_BUCKET: ${EVENTS_S3_BUCKET}
    networks:
      - octo_box
  octobot:
    container_name: octo-bot
    image: docker.io/halotools/don-bot:latest
    restart: always
    read_only: true
    depends_on:
      - celeryworker
    links:
      - "rabbitmq:5672"
      - "redis:6379"
      - "flower:5555"
    environment:
      # NOSLACK: "true"
      CELERY_BACKEND_URL: redis://redis
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672//
      FLOWER_HOST: http://flower:5555
      HALO_API_KEY: ${HALO_API_KEY}
      HALO_API_SECRET_KEY: ${HALO_API_SECRET_KEY}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      SLACK_API_TOKEN: ${SLACK_API_TOKEN}
      SLACK_CHANNEL: ${SLACK_CHANNEL}
      MONITOR_EVENTS: "yes"
      ARCHIVE_SCANS: "yes"
      SCANS_S3_BUCKET: ${SCANS_S3_BUCKET}
      ARCHIVE_EVENTS: "yes"
      EVENTS_S3_BUCKET: ${EVENTS_S3_BUCKET}
    networks:
      - octo_box
#####################################
#  This is not ready yet, and currently only supports listing tasks.
#  No authentication.  Only use in a controlled troubleshooting environment.
#
#  web:
#    container_name: web
#    build: ./web
#    restart: always
#    depends_on:
#      - celeryworker
#    volumes:
#      - /etc/letsencrypt:/etc/letsencrypt
#    environment:
#      PORTAL_DNS_NAME: ${PORTAL_DNS_NAME}
#    links:
#      - "appserver:5000"
#    ports:
#      - 443:443
#    networks:
#      - octo_box
#  appserver:
#    container_name: appserver
#    build: ./appserver
#    restart: always
#    read_only: true
#    environment:
#      FLOWER_HOST: http://flower:5555
#      CELERY_BACKEND_URL: redis://redis
#      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672//
#      HALO_API_KEY: ${HALO_API_KEY}
#      HALO_API_SECRET_KEY: ${HALO_API_SECRET_KEY}
#      FLASK_SECRET_KEY: ${FLASK_SECRET_KEY}
#    depends_on:
#      - celeryworker
#    links:
#      - "rabbitmq:5672"
#      - "redis:6379"
#      - "flower:5555"
#    networks:
#      - octo_box

networks:
  octo_box:
    driver: bridge
